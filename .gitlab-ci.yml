variables:
  # Configure postgres service (https://hub.docker.com/_/postgres/)
  POSTGRES_DB: ece651
  POSTGRES_USER: ece651_admin
  POSTGRES_PASSWORD: YbRvAizCTnbQ5W6JI69h
  PG_SCRAPER_USER: ece651_scraper
  PG_SCRAPER_PASS: wxJcTdJYUU3mMAsAa5YD
  PG_ML_USER: ece651_ml
  PG_ML_PASS: TVL3MV0mguz0DOhLbbm2
  PG_WEB_USER: ece651_web
  PG_WEB_PASS: dm2fBdodbrHPtJVvlSKF

setup image:
  image: ubuntu
  only:
    - tags
    - triggers
  stage: build
  script:
    - whoami
    # - chmod +x ./docker-ubuntu-setup-script.sh
    # - ./docker-ubuntu-setup-script.sh
    - echo =================================================
    - echo Running the Docker Ubuntu Setup Script for ECE651
    - echo =================================================
    - cat /etc/os-release
    - echo 
    - echo 
    - echo ==============================================
    - echo Installing Python 3 and Misc/Required Packages
    - echo ==============================================
    # set noninteractive installation
    - export DEBIAN_FRONTEND=noninteractive
    #install tzdata package
    - apt-get update && apt-get install -y tzdata
    - apt-get update && apt-get install -y curl wget gnupg2
    - echo 
    - echo 
    - echo ==============================================
    - echo Installing Postgres 11
    - echo ==============================================
    # INSTALL POSTGRES
    - export RELEASE=$(cat /etc/os-release  | grep VERSION_CODENAME  | cut -d= -f2)
    - echo "deb http://apt.postgresql.org/pub/repos/apt/ ${RELEASE}"-pgdg 11 | tee  /etc/apt/sources.list.d/pgdg.list
    - wget --quiet https://www.postgresql.org/media/keys/ACCC4CF8.asc
    - apt-key add ACCC4CF8.asc
    - apt-get update && apt-cache show postgresql-11
    - echo exit 0 > /usr/sbin/policy-rc.d
    - apt-get update && apt-get install -y postgresql-11 postgresql-server-dev-11 libpq-dev
    # 
    # 
    # SETUP THE DATABASE
    # official way to provide password to psql: http://www.postgresql.org/docs/9.3/static/libpq-envars.html
    - export PGPASSWORD=$POSTGRES_PASSWORD
    - psql -h "localhost" -U "$POSTGRES_USER" -d "$POSTGRES_DB" -f src/db/create-users_postgre.sql
    #- psql -h "postgres" -U "$POSTGRES_USER" -d "$POSTGRES_DB" -f src/db/database-create_postgre.sql
    - psql -q -h "localhost" -U "$POSTGRES_USER" -d "$POSTGRES_DB" -f src/db/create_tables_load_content.sql
    - export PGPASSWORD=$PG_SCRAPER_PASS
    - psql -h "localhost" -U "$PG_SCRAPER_USER" -d "$POSTGRES_DB" -c 'SELECT * FROM public."BookOfTheDay" LIMIT 10;'
    - export PGPASSWORD=$PG_ML_PASS
    - psql -h "localhost" -U "$PG_ML_USER" -d "$POSTGRES_DB" -c 'SELECT * FROM public."Books" LIMIT 10;'
    - psql -h "localhost" -U "$PG_ML_USER" -d "$POSTGRES_DB" -c 'SELECT * FROM public."BookDetails" LIMIT 10;'
    - export PGPASSWORD=$PG_WEB_PASS
    - psql -h "localhost" -U "$PG_WEB_USER" -d "$POSTGRES_DB" -c 'SELECT * FROM public."Users" LIMIT 10;'

node version:
  only:
    - tags
    - triggers
  stage: test
  image: ubuntu
  script:
    - node --version
    - cd src/web
    - npm install

python tests:
  only:
    - tags
    - triggers
  stage: test
  image: ubuntu
  script:
    - cd src/scraper
    - pip install -r requirements.txt
    - export PGPASSWORD=$PG_SCRAPER_PASS
    - psql -h "postgres" -U "$PG_SCRAPER_USER" -d "$POSTGRES_DB" -c 'SELECT * FROM public."BookOfTheDay";'
    - export TESTENV=true
    - python -m unittest discover